#lang racket

;; Wall smoothing is so tricky to get right (for all I know, it may still
;; not be right) that it deserves a test suite of its own.
;; That, and the tests are individually quite large, so let's put them in
;; their own file.

(require rackunit
         "grid.rkt" "dungeon.rkt")

(define (render-grid g) (string-join g "\n" #:after-last "\n"))

(define (check-smoothing t expected)
  (define g (parse-grid t))
  (check-equal? (show-grid (smooth-walls g))
                (render-grid expected)))

;; Most of those are cases that the previous iterations of the smoothing
;; algorithm got wrong. So those are already mostly smoothed.

(check-smoothing
 '(
   "..............╔═════╗......................................."
   "...╔═════╗....║     ║......................................."
   "...║     ║....║     ║......................................."
   "...║     ╠════╣     ║......................................."
   "...║     |    |     ║................╔════╗.......╔═════╗..."
   "...║     ╠════╩═╦-╦═╝................║    ║.......║     ║..."
   "...╚╦-╦══╣......║ ║...╔═══════╗......║    ║.......║     ║..."
   "....║ ║..╠══════╣ ║...║       ║......║    ╠═══════╣     ║..."
   "....║ ║..║      ║ ║...║       ╠══════╣    |       |     ║..."
   "....║ ║..║      ╠-╩═══╣       |      |    ╠═══════╣     ║..."
   "..╔═╩-╩═╗╣      |     |       ╠══════╩════╝.......║     ║..."
   "..║     ║║      ╠═════╩═══════╝...................║     ║..."
   "..║     ╠╚══════╝.................................╚═════╝..."
   "..║     ║..................................................."
   "..║     ║..................................................."
   "..╚═════╝..................................................."
   "............................................................"
   "............................................................"
   )
 '(
   "..............╔═════╗......................................."
   "...╔═════╗....║     ║......................................."
   "...║     ║....║     ║......................................."
   "...║     ╠════╣     ║......................................."
   "...║     |    |     ║................╔════╗.......╔═════╗..."
   "...║     ╠════╩═╦-╦═╝................║    ║.......║     ║..."
   "...╚╦-╦══╝......║ ║...╔═══════╗......║    ║.......║     ║..."
   "....║ ║..╔══════╣ ║...║       ║......║    ╠═══════╣     ║..."
   "....║ ║..║      ║ ║...║       ╠══════╣    |       |     ║..."
   "....║ ║..║      ╠-╩═══╣       |      |    ╠═══════╣     ║..."
   "..╔═╩-╩═╗║      |     |       ╠══════╩════╝.......║     ║..."
   "..║     ║║      ╠═════╩═══════╝...................║     ║..."
   "..║     ║╚══════╝.................................╚═════╝..."
   "..║     ║..................................................."
   "..║     ║..................................................."
   "..╚═════╝..................................................."
   "............................................................"
   "............................................................"
   ))

(check-smoothing
 '(
   "............................................................"
   "..........................XXXXXX............................"
   "..........................X    X............................"
   "XXXXXXX...................X    XXXXXXXXXXXXXXX.............."
   "X     X...................X    |      |      X.....XXXXXXXXX"
   "X     X.....XXXXXXX.......X    XXXXXXXX      X.....X       X"
   "X     XXXXXXX     X.......XXXXXX......X      X.....X       X"
   "X     |     |     XXXXXXXXX    X......X      XXXXXXX       X"
   "X     X-XXXXX     |       |    XXXXXXXX      |     |       X"
   "X     X X...X     XXXXXXXXX    |      |      XXXXXXX       X"
   "XXXXXXX X...X     X.......X    XXXXXXXX      X.....X       X"
   "......X X...XXXXXXX.......XXXXXX......XXXXXXXX.....XXXXXXXXX"
   "....XXX-XXX................................................."
   "....X     X................................................."
   "....X     X................................................."
   "....X     X................................................."
   "....X     X................................................."
   "....XXXXXXX................................................."
   )
  '(
   "............................................................"
   "..........................╔════╗............................"
   "..........................║    ║............................"
   "╔═════╗...................║    ╠══════╦══════╗.............."
   "║     ║...................║    |      |      ║.....╔═══════╗"
   "║     ║.....╔═════╗.......║    ╠══════╣      ║.....║       ║"
   "║     ╠═════╣     ║.......╠════╣......║      ║.....║       ║"
   "║     |     |     ╠═══════╣    ║......║      ╠═════╣       ║"
   "║     ╠-╦═══╣     |       |    ╠══════╣      |     |       ║"
   "║     ║ ║...║     ╠═══════╣    |      |      ╠═════╣       ║"
   "╚═════╣ ║...║     ║.......║    ╠══════╣      ║.....║       ║"
   "......║ ║...╚═════╝.......╚════╝......╚══════╝.....╚═══════╝"
   "....╔═╩-╩═╗................................................."
   "....║     ║................................................."
   "....║     ║................................................."
   "....║     ║................................................."
   "....║     ║................................................."
   "....╚═════╝................................................."
   ))

(check-smoothing
 '(
   "............................╔══════╗........................"
   "............................║      ║........................"
   "............................║      ║.................╔═════╗"
   "................╔═════╦═════╣      ║.................║     ║"
   "................║     |     |      ║.......╔════╦════╣     ║"
   "....╔═════╗.....║     ╠═════╣      ║.......║    |    |     ║"
   "....║     ╠═════╣     ║.....║      ╠═══════╣    ╠══╦-╣     ║"
   "....║     |     |     ║.....║      |       |    ║..║ ║     ║"
   "....║     ╠═══╦-╣     ║.....╚══════╩═══════╣    ║..║ ╠═════╝"
   "....║     ║...║ ║     ║....................║    ║..║ ║......"
   "....║     ║...║ ║     ║....................╚════╩╦═╩-╩═╗...."
   "....║     ║...║ ╚═════╝..........................║     ║...."
   "....║     ╚╔══╩-╩══╗.............................║     ║...."
   "....╚═════╝╗       ║.............................║     ║...."
   "...........║       ║.............................║     ║...."
   "...........║       ║.............................║     ║...."
   "...........║       ║.............................╚═════╝...."
   "...........╚═══════╝........................................"
   )
 '(
   "............................╔══════╗........................"
   "............................║      ║........................"
   "............................║      ║.................╔═════╗"
   "................╔═════╦═════╣      ║.................║     ║"
   "................║     |     |      ║.......╔════╦════╣     ║"
   "....╔═════╗.....║     ╠═════╣      ║.......║    |    |     ║"
   "....║     ╠═════╣     ║.....║      ╠═══════╣    ╠══╦-╣     ║"
   "....║     |     |     ║.....║      |       |    ║..║ ║     ║"
   "....║     ╠═══╦-╣     ║.....╚══════╩═══════╣    ║..║ ╠═════╝"
   "....║     ║...║ ║     ║....................║    ║..║ ║......"
   "....║     ║...║ ║     ║....................╚════╝╔═╩-╩═╗...."
   "....║     ║...║ ╠═════╝..........................║     ║...."
   "....║     ║╔══╩-╩══╗.............................║     ║...."
   "....╚═════╝║       ║.............................║     ║...."
   "...........║       ║.............................║     ║...."
   "...........║       ║.............................║     ║...."
   "...........║       ║.............................╚═════╝...."
   "...........╚═══════╝........................................"
   ))

(check-smoothing
 '(
   "............................................................"
   "╔════╗..................................╔════╗.............."
   "║    ║..................................║    ║.............."
   "║    ║.....................╔═══════╗....║    ║.............."
   "║    ╠═══════╦═════╗.......║       ║....║    ╠════╦═════╗..."
   "║    |       |     ║.......║       ║....║    |    |     ║..."
   "║    ╠═══════╣     ╠═══════╣       ╠════╣    ╠═╦-╦╣     ║..."
   "║    ║.......║     |       |       |    |    ║.║ ║║     ║..."
   "║    ║.......║     ╠═══════╣       ╠════╣    ║.║ ║║     ║..."
   "╚════╝.......╚═════╝.......║       ║....╚════╣.║ ║║     ║..."
   "...........................╚═══════╝.........╠═╩-╩╩╦════╝..."
   ".............................................║     ║........"
   ".............................................║     ║........"
   ".............................................║     ║........"
   ".............................................║     ║........"
   ".............................................║     ║........"
   ".............................................╚═════╝........"
   "............................................................"
   )
 '(
   "............................................................"
   "╔════╗..................................╔════╗.............."
   "║    ║..................................║    ║.............."
   "║    ║.....................╔═══════╗....║    ║.............."
   "║    ╠═══════╦═════╗.......║       ║....║    ╠════╦═════╗..."
   "║    |       |     ║.......║       ║....║    |    |     ║..."
   "║    ╠═══════╣     ╠═══════╣       ╠════╣    ╠═╦-╦╣     ║..."
   "║    ║.......║     |       |       |    |    ║.║ ║║     ║..."
   "║    ║.......║     ╠═══════╣       ╠════╣    ║.║ ║║     ║..."
   "╚════╝.......╚═════╝.......║       ║....╚════╝.║ ║║     ║..."
   "...........................╚═══════╝.........╔═╩-╩╩╦════╝..."
   ".............................................║     ║........"
   ".............................................║     ║........"
   ".............................................║     ║........"
   ".............................................║     ║........"
   ".............................................║     ║........"
   ".............................................╚═════╝........"
   "............................................................"
   ))

(check-smoothing
 '(
   ".......╔════╗..............................................."
   ".......║    ║.................................╔══════╗......"
   ".......║    ║.................................║      ║......"
   ".......║    ╠════╦═════╗......╔═══════╦═══════╣      ║......"
   ".......║    |    |     ║......║       |       |      ║......"
   ".......║    ╠════╣     ║......║       ╠═══════╣      ║......"
   ".......║    ║....║     ╠══════╣       ║.......╚══════╝......"
   ".......╚══╦-╣....║     |      |       ║....................."
   "..........║ ║....║     ╠══════╣       ║....................."
   "..........║ ║....║     ║......║       ║....................."
   "..........║ ║....╚═════╬═════╦╩═══════╝....................."
   "..........║ ║..........║     ║.............................."
   ".......╔══╩-╩══╦═══════╣     ║.............................."
   ".......║       |       |     ║.............................."
   ".......║       ╠═══════╣     ║.............................."
   ".......║       ║.......║     ║.............................."
   ".......║       ║.......╚═════╝.............................."
   ".......╚═══════╝............................................"
   )
 '(
   ".......╔════╗..............................................."
   ".......║    ║.................................╔══════╗......"
   ".......║    ║.................................║      ║......"
   ".......║    ╠════╦═════╗......╔═══════╦═══════╣      ║......"
   ".......║    |    |     ║......║       |       |      ║......"
   ".......║    ╠════╣     ║......║       ╠═══════╣      ║......"
   ".......║    ║....║     ╠══════╣       ║.......╚══════╝......"
   ".......╚══╦-╣....║     |      |       ║....................."
   "..........║ ║....║     ╠══════╣       ║....................."
   "..........║ ║....║     ║......║       ║....................."
   "..........║ ║....╚═════╬═════╗╚═══════╝....................."
   "..........║ ║..........║     ║.............................."
   ".......╔══╩-╩══╦═══════╣     ║.............................."
   ".......║       |       |     ║.............................."
   ".......║       ╠═══════╣     ║.............................."
   ".......║       ║.......║     ║.............................."
   ".......║       ║.......╚═════╝.............................."
   ".......╚═══════╝............................................"
   ))

(check-smoothing
 '(
   "............................................................"
   "..........XXXXXXX...............XXXXXXXXX..................."
   "..........X     X....XXXXXXX....X       X..................."
   "..........X     XXXXXX     X....X       X..................."
   "..........X     |    |     X....X       X..................."
   "..........X     XXXXXX     X....X       X..................."
   "..........XXXXXXX....X     X....XXXX-XXXX..................."
   ".......XXXXXX........XXX-XXXXXXXXXXX X......................"
   ".......X    X....XXXXXXX X..X      X X....XXXXXXX..........."
   ".......X    XXXXXX     X X..X      X X....X     X..........."
   ".......X    |    |     X X..X      X-XXXXXX     X..........."
   ".......X    XXXXXX     X-XXXX      |      |     X..........."
   ".......X    X....X     |    |      XXXXXXXX     X..........."
   ".......XXXXXX....X     XXXXXX      X......X     X..........."
   ".................X     X....XXXXXXXX......X     X..........."
   ".................XXXXXXX..................XXXXXXX..........."
   "............................................................"
   "............................................................"
   )
 '(
   "............................................................"
   "..........╔═════╗...............╔═══════╗..................."
   "..........║     ║....╔═════╗....║       ║..................."
   "..........║     ╠════╣     ║....║       ║..................."
   "..........║     |    |     ║....║       ║..................."
   "..........║     ╠════╣     ║....║       ║..................."
   "..........╚═════╝....║     ║....╚══╦-╦══╝..................."
   ".......╔════╗........╚═╦-╦═╝╔══════╣ ║......................"
   ".......║    ║....╔═════╣ ║..║      ║ ║....╔═════╗..........."
   ".......║    ╠════╣     ║ ║..║      ║ ║....║     ║..........."
   ".......║    |    |     ║ ║..║      ╠-╩════╣     ║..........."
   ".......║    ╠════╣     ╠-╩══╣      |      |     ║..........."
   ".......║    ║....║     |    |      ╠══════╣     ║..........."
   ".......╚════╝....║     ╠════╣      ║......║     ║..........."
   ".................║     ║....╚══════╝......║     ║..........."
   ".................╚═════╝..................╚═════╝..........."
   "............................................................"
   "............................................................"
   ))

(check-smoothing
 '(
   "............................................................"
   ".............XXXXXXX........................................"
   ".............X     X........................................"
   ".............X     XXXXXXXXXXXXX.......XXXXXX.......XXXXXXX."
   ".............X     |    |      X.......X    X.......X     X."
   ".....XXXXXXXXX     XX-XXX      XXXXXXXXX    X.......X     X."
   ".....X      XX     XX X.X      |       |    XXXXXXXXX     X."
   ".....X      XXXXXXXXX X.X      XXXXXXXXX    |       |     X."
   ".....X      XXXXXXXXX X.XXXXXXXX.......X    XXXXXXXXX     X."
   ".....X      |       | X................X    X.......XXXXXXX."
   ".....X      XXXXXXXXX X................X    X..............."
   ".....X      X.....XXX-XXX..............XXXXXX..............."
   ".....X      X.....X     X..................................."
   ".....XXXXXXXX.....X     X..................................."
   "..................X     X..................................."
   "..................X     X..................................."
   "..................X     X..................................."
   "..................XXXXXXX..................................."
   )
 '(
   "............................................................"
   ".............╔═════╗........................................"
   ".............║     ║........................................"
   ".............║     ╠════╦══════╗.......╔════╗.......╔═════╗."
   ".............║     |    |      ║.......║    ║.......║     ║."
   ".....╔══════╗║     ╠╦-╦═╣      ╠═══════╣    ║.......║     ║."
   ".....║      ║║     ║║ ║.║      |       |    ╠═══════╣     ║."
   ".....║      ║╚═════╝║ ║.║      ╠═══════╣    |       |     ║."
   ".....║      ╠═══════╣ ║.╚══════╝.......║    ╠═══════╣     ║."
   ".....║      |       | ║................║    ║.......╚═════╝."
   ".....║      ╠═══════╣ ║................║    ║..............."
   ".....║      ║.....╔═╩-╩═╗..............╚════╝..............."
   ".....║      ║.....║     ║..................................."
   ".....╚══════╝.....║     ║..................................."
   "..................║     ║..................................."
   "..................║     ║..................................."
   "..................║     ║..................................."
   "..................╚═════╝..................................."
   ))

(check-smoothing
 '(
   ".......................XXXXXXXX....................XXXXXXXXX"
   ".......................X      X.......XXXXXX.......X       X"
   ".......................X      XXXXXXXXX    X.......X       X"
   ".......................X      |       |    X.......X       X"
   "............XXXXXXXX...X      XXXXXXXXX    XXXXXXXXX       X"
   "............X      X...XXXXXXXXXXX....X    |       |       X"
   "............X      XXXXXXX       X....X    XXX-XXXXX       X"
   "............X      |     |       XXXXXX    X.X X...X       X"
   "............X      XXXXXXX       |    |    X.X X...XXX-XXXXX"
   "............XXXXXXXX.....X       XXXXXXXXXXX.X X.....X X...."
   ".........................X       X........XXXX-XXX...X X...."
   ".........................XXXXXXXXX........X      X...X X...."
   "..........................................X      XXXXX-XXX.."
   "..........................................X      XX      X.."
   "..........................................X      XX      X.."
   "..........................................X      XX      X.."
   "..........................................XXXXXXXXX      X.."
   "..................................................XXXXXXXX.."
   )
 '(
   ".......................╔══════╗....................╔═══════╗"
   ".......................║      ║.......╔════╗.......║       ║"
   ".......................║      ╠═══════╣    ║.......║       ║"
   ".......................║      |       |    ║.......║       ║"
   "............╔══════╗...║      ╠═══════╣    ╠═══════╣       ║"
   "............║      ║...╚═╦════╩══╗....║    |       |       ║"
   "............║      ╠═════╣       ║....║    ╠═╦-╦═══╣       ║"
   "............║      |     |       ╠════╣    ║.║ ║...║       ║"
   "............║      ╠═════╣       |    |    ║.║ ║...╚═╦-╦═══╝"
   "............╚══════╝.....║       ╠════╩════╝.║ ║.....║ ║...."
   ".........................║       ║........╔══╩-╩═╗...║ ║...."
   ".........................╚═══════╝........║      ║...║ ║...."
   "..........................................║      ║╔══╩-╩═╗.."
   "..........................................║      ║║      ║.."
   "..........................................║      ║║      ║.."
   "..........................................║      ║║      ║.."
   "..........................................╚══════╝║      ║.."
   "..................................................╚══════╝.."
   ))

(check-smoothing
 '(
   "............................................................"
   "....╔══════╗................................................"
   "....║      ║................................................"
   "....║      ║....╔═════╗....................................."
   "....║      ║....║     ║....................................."
   "....║      ║....║     ║....................................."
   "....╚══╦-╦═╩════╣     ║....................................."
   ".......║ |      |     ║.............╔═════╗................."
   "╔════╗.║ ╠══════╣     ║.............║     ║................."
   "║    ║.║ ║╝═════╣     ║.............║     ║................."
   "║    ╠═╩-╩╣     ╠═════╝.╔══════╦════╣     ║................."
   "║    |    |     ║.......║      |    |     ║................."
   "║    ╠════╣     ╠═══════╣      ╠════╣     ║................."
   "╚════╝....║     |       |      ║....║     ║................."
   "..........║     ╠═══════╣      ║....╚═════╝................."
   "..........║     ║.......╚══════╝............................"
   "..........╚═════╝..........................................."
   "............................................................"
   )
 '(
   "............................................................"
   "....╔══════╗................................................"
   "....║      ║................................................"
   "....║      ║....╔═════╗....................................."
   "....║      ║....║     ║....................................."
   "....║      ║....║     ║....................................."
   "....╚══╦-╦═╩════╣     ║....................................."
   ".......║ |      |     ║.............╔═════╗................."
   "╔════╗.║ ╠══════╣     ║.............║     ║................."
   "║    ║.║ ║╔═════╣     ║.............║     ║................."
   "║    ╠═╩-╩╣     ╠═════╝.╔══════╦════╣     ║................."
   "║    |    |     ║.......║      |    |     ║................."
   "║    ╠════╣     ╠═══════╣      ╠════╣     ║................."
   "╚════╝....║     |       |      ║....║     ║................."
   "..........║     ╠═══════╣      ║....╚═════╝................."
   "..........║     ║.......╚══════╝............................"
   "..........╚═════╝..........................................."
   "............................................................"
   ))
